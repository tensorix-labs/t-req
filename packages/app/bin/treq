#!/usr/bin/env node

const childProcess = require("child_process")
const fs = require("fs")
const path = require("path")
const os = require("os")

function run(target) {
  const result = childProcess.spawnSync(target, process.argv.slice(2), {
    stdio: "inherit",
  })
  if (result.error) {
    console.error(result.error.message)
    process.exit(1)
  }
  process.exit(result.status ?? 0)
}

const scriptDir = path.dirname(fs.realpathSync(__filename))

const platformMap = { darwin: "darwin", linux: "linux", win32: "windows" }
const archMap = { x64: "x64", arm64: "arm64" }

const platform = platformMap[os.platform()] ?? os.platform()
const arch = archMap[os.arch()] ?? os.arch()
const base = "app-" + platform + "-" + arch
const binary = platform === "windows" ? "treq.exe" : "treq"

function findBinary(startDir) {
  let current = startDir
  while (true) {
    const modules = path.join(current, "node_modules")
    if (fs.existsSync(modules)) {
      for (const entry of fs.readdirSync(modules)) {
        if (entry === "@t-req") {
          const scopedPath = path.join(modules, "@t-req")
          for (const scopedEntry of fs.readdirSync(scopedPath)) {
            if (scopedEntry.startsWith(base)) {
              const candidate = path.join(scopedPath, scopedEntry, "bin", binary)
              if (fs.existsSync(candidate)) return candidate
            }
          }
        }
      }
    }
    const parent = path.dirname(current)
    if (parent === current) return null
    current = parent
  }
}

const resolved = findBinary(scriptDir)
if (!resolved) {
  console.error(`Failed to find @t-req/${base} binary. Try reinstalling @t-req/app.`)
  process.exit(1)
}

run(resolved)
